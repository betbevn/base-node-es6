<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/forge/1.3.1/forge.min.js"></script>
    <script>
      const PKI = forge.pki;
      const MD = forge.md;
      const publicKeyPem = `
        -----BEGIN PUBLIC KEY-----
  MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA3kcYa65r7jK0qp7oxUjW
  4ESbqCWNfjHWtplROwG3Nt8a0SdPfp9buHOY1RLIY4PYPD/3CL89DwKSgj7y0fA0
  rZY/FA/AkZBFyq/Dt8f2LBoqRg/Ai5HSpvvaY6AgVYCfgMOdLvMOubAAXs9z/07W
  B2M5+rOG0F55LmMJ1Upl1DitgnOhQmj/DPW7UjYI8N9wBrbR6DMW4Qhmv6PdEvmG
  Ph20c8XQbrXiOexJCEoGTtPIvT0eP9KHVkpr7G2vQb3mzp+C0F4K47iVzO5igo3y
  rca7AAemnRz8yflFbISoKD0wXLB5jH3LIvprREQgIVsL6o12KMyLU9BkigxfzrSQ
  7QIDAQAB
        -----END PUBLIC KEY-----
  `;

      function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        const publicKey = PKI.publicKeyFromPem(publicKeyPem);
        const encryptedPassword = publicKey.encrypt(
          password,
          "RSAES-PKCS1-V1_5"
        );

        const url = "http://localhost:4848/api/auth/login";
        const options = {
          method: "POST",
          body: JSON.stringify({
            email: email,
            encryptedPassword: encryptedPassword,
            publicKey: publicKeyPem,
          }),
          headers: {
            "Content-Type": "application/json",
          },
        };
        fetch(url, options)
          .then(getUsers)
          .then(console.log)
          .catch(console.error)
          .finally(() => {
            resetForm();
          });
      }

      function signup() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        const publicKey = PKI.publicKeyFromPem(publicKeyPem);
        const encryptedPassword = publicKey.encrypt(
          password,
          "RSAES-PKCS1-V1_5"
        );

        const url = "http://localhost:4848/api/auth/signup";
        const options = {
          method: "POST",
          body: JSON.stringify({
            email: email,
            encryptedPassword: encryptedPassword,
          }),
          headers: {
            "Content-Type": "application/json",
          },
        };
        fetch(url, options)
          .then(console.log)
          .catch(console.error)
          .finally(() => {
            resetForm();
          });
      }

      async function getUsers(response) {
        let data = await response.json();
        const token = data.data.token;
        const user = data.data.user;

        const url = `http://localhost:4848/api/users/${user._id}`;
        const options = {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
        };
        return fetch(url, options).then((response) => response.json());
      }

      // function logOut() {
      //   window.localStorage.removeItem("token");
      // }

      // function logOut() {
      //   const url = "http://localhost:6868/api/auth/logout";
      //   const options = {
      //     method: "POST",
      //     credentials: "include",
      //   };
      //   return fetch(url, options).then((response) => response.json());
      // }

      function resetForm() {
        document.getElementById("email").value = "";
        document.getElementById("password").value = "";
      }
    </script>
  </head>
  <body>
    <h1>Hello C2 Demo: Secure JWT with public/private keys pair</h1>

    <div style="display: flex; justify-content: center">
      <form id="myForm" action="#">
        <div style="margin: 20px">
          <input id="email" type="text" placeholder="email" name="email" />
        </div>
        <div style="margin: 20px">
          <input
            id="password"
            type="password"
            placeholder="password"
            name="password"
          />
        </div>
        <div id="error-message" style="color: red; margin: 20px"></div>
        <div style="display: flex; justify-content: end; margin: 20px">
          <input type="button" value="Sign up" onclick="signup()" />
          <input
            type="button"
            value="Login"
            onclick="login()"
            style="margin-left: 5px"
          />
        </div>
      </form>
    </div>
  </body>
</html>
